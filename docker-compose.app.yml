services:
  gwiki:
    image: ${GWIKI_IMAGE:-gwiki:latest}
    ports:
      - "8080:8080"
    volumes:
      - "${WIKI_REPO_PATH_HOST:-.}:/notes"
      - "${WIKI_DATA_PATH_HOST:-./.wiki}:/data"
      - "${GIT_HOME_HOST:-./git-home}:/git-home"
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      - HOME=/home/gwiki
      - GIT_CONFIG_GLOBAL=/git-home/.gitconfig
      - GIT_CREDENTIALS_FILE=/git-home/.git-credentials
      - WIKI_REPO_PATH=/notes
      - WIKI_DATA_PATH=/data
      - TZ=${TZ:-Asia/Jakarta}

  e2e:
    image: mcr.microsoft.com/playwright:v1.50.0-jammy
    depends_on:
      - gwiki
    working_dir: /work/tests/e2e
    volumes:
      - .:/work
    environment:
      - E2E_BASE_URL=http://gwiki:8080
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
    entrypoint: ["/bin/bash", "-lc"]
    command: >
      apt-get update &&
      apt-get install -y ca-certificates curl &&
      curl -fsSL https://go.dev/dl/go1.22.5.linux-amd64.tar.gz | tar -C /usr/local -xz &&
      export PATH=/usr/local/go/bin:$PATH &&
      go mod download &&
      go install github.com/playwright-community/playwright-go/cmd/playwright@v0.5200.1 &&
      playwright install &&
      go test ./...
