{{define "sidebar"}}
<div class="sidebar-shell">
  <details
    data-sidebar
    class="w-full rounded-3xl border border-slate-800/70 bg-[#121417]/80 p-4 shadow-[0_30px_90px_-60px_rgba(0,0,0,0.95)] backdrop-blur md:p-5"
  >
    <summary class="sidebar-summary cursor-pointer list-none text-sm font-semibold text-slate-200 lg:hidden">
      {{template "sidebar_brand_display" .}}
    </summary>
    <div class="mt-4 flex min-h-[60vh] flex-col gap-6 md:mt-0">
      {{template "sidebar_brand_button" .}}
      <div class="border-y border-slate-800/70 py-4">
        {{template "sidebar_user_row" .}}
      </div>
      <div class="space-y-6">{{template "sidebar_content" .}}</div>
      <div class="flex-1"></div>
    </div>
  </details>
</div>
{{end}}

{{define "sidebar_content"}}
  {{template "calendar_skeleton" .}}

<div class="border-t border-slate-800/70 pt-4">
  <div
    class="flex items-center justify-between text-xs uppercase tracking-[0.25em] text-slate-500"
  >
    <a class="text-slate-500 transition hover:text-slate-300" href="{{.TodoURL}}" data-preserve-month="true">Todo ({{.DueCount}} / {{.TodoCount}})</a>
    <span class="text-slate-600">.</span>
  </div>
</div>

<div class="border-t border-slate-800/70 pt-4">
  <div
    class="flex items-center justify-between text-xs uppercase tracking-[0.25em] text-slate-500"
  >
    <span>Tags</span>
    <span class="text-slate-600">.</span>
  </div>
  <div class="mt-3 flex flex-wrap gap-2 text-xs">
    {{range .TagLinks}} {{if .Disabled}}
    <span
      class="rounded-full border border-slate-800/70 bg-[#15181c]/60 px-2.5 py-1 text-slate-600"
      >#{{.Name}} ({{.Count}})</span
    >
    {{else}}
    <a
      data-preserve-month="true"
      class="rounded-full border px-2.5 py-1 transition {{if .Active}}border-sky-500 bg-sky-500/20 text-sky-200{{else}}border-slate-700/70 bg-[#15181c] text-slate-300 hover:border-slate-500{{end}}"
      href="{{.URL}}"
      >#{{.Name}} ({{.Count}})</a
    >
    {{end}} {{else}}
    <span class="text-slate-500">No tags yet.</span>
    {{end}}
  </div>
</div>

<div class="border-t border-slate-800/70 pt-4">
  <div
    class="flex items-center justify-between text-xs uppercase tracking-[0.25em] text-slate-500"
  >
    <span>Folders</span>
    <span class="text-slate-600">.</span>
  </div>
  <div class="journal-tree mt-3 text-xs">
    {{template "folder_tree" .FolderTree}}
  </div>
</div>

{{if or (and .IsAuthenticated .CurrentUser.Name) .Groups}}
<div class="border-t border-slate-800/70 pt-4">
  <div
    class="flex items-center justify-between text-xs uppercase tracking-[0.25em] text-slate-500"
  >
    <span>User &amp; Groups</span>
    <span class="text-slate-600">.</span>
  </div>
  <div class="mt-3 flex flex-wrap gap-2 text-xs">
    {{if and .IsAuthenticated .CurrentUser.Name}}
      <a class="rounded-full border border-slate-800/70 bg-[#15181c]/60 px-2.5 py-1 text-slate-300 transition hover:border-slate-500 hover:text-slate-100" href="/{{.CurrentUser.Name}}">{{.CurrentUser.Name}}</a>
    {{end}}
    {{range .Groups}}
      <a class="rounded-full border border-slate-800/70 bg-[#15181c]/60 px-2.5 py-1 text-slate-300 transition hover:border-slate-500 hover:text-slate-100" href="/{{.}}">{{.}}</a>
    {{end}}
  </div>
</div>
{{end}}

{{end}}

{{define "sidebar_brand_button"}}
  <div class="flex w-full items-center gap-3 text-left">
    <button type="button" data-quick-launcher="true" class="flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-800/80 bg-[#0f1216]" aria-label="Quick launcher">
      <img class="h-9 w-9 object-contain" src="/static/scroll.png" alt="Gwiki">
    </button>
    <button type="button" class="js-sidebar-toggle text-left lg:pointer-events-none" aria-label="Toggle sidebar">
      {{template "sidebar_brand_text" .}}
    </button>
  </div>
{{end}}

{{define "sidebar_brand_display"}}
  <div class="flex w-full items-center gap-3 text-left">
    <button type="button" data-quick-launcher="true" class="flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-800/80 bg-[#0f1216]" aria-label="Quick launcher">
      <img class="h-9 w-9 object-contain" src="/static/scroll.png" alt="Gwiki">
    </button>
    {{template "sidebar_brand_text" .}}
  </div>
{{end}}

{{define "sidebar_brand_text"}}
  <div class="space-y-0.5 text-left font-normal leading-tight">
    <div class="text-sm font-semibold tracking-[0.25em] text-slate-100">GWIKI</div>
    <div class="text-[10px] font-normal uppercase tracking-[0.22em] text-slate-500">v{{.BuildVersion}}</div>
  </div>
{{end}}

{{define "sidebar_user_row"}}
  <div class="flex w-full items-center justify-between gap-2 text-xs uppercase tracking-[0.2em] text-slate-500">
    {{if and .AuthEnabled .IsAuthenticated}}
      <span class="text-xs text-slate-200">{{.CurrentUser.Name}}</span>
      <div class="flex items-center gap-2">
        <a class="inline-flex h-9 w-9 items-center justify-center rounded-2xl border border-slate-800/80 bg-[#15181c] text-slate-300 transition hover:text-slate-100" href="/" aria-label="Home">
          <svg viewBox="0 0 20 20" aria-hidden="true" class="h-4 w-4 fill-current">
            <path d="M10 3.4 3.7 8.6a.75.75 0 1 0 .96 1.15l.84-.7v6.04c0 .41.34.75.75.75h2.8a.75.75 0 0 0 .75-.75v-3.4h1.4v3.4c0 .41.34.75.75.75h2.8c.41 0 .75-.34.75-.75V9.2l.84.7a.75.75 0 0 0 .96-1.15L10.48 3.4a.75.75 0 0 0-.96 0Z"/>
          </svg>
        </a>
        <a class="inline-flex h-9 w-9 items-center justify-center rounded-2xl border border-slate-800/80 bg-[#15181c] text-slate-300 transition hover:text-slate-100" href="/logout" aria-label="Logout">
          <svg viewBox="0 0 20 20" aria-hidden="true" class="h-4 w-4 fill-current">
            <path d="M8.5 3.5h-3a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h3v-1.5h-3a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h3V3.5z"/>
            <path d="M12.94 6.44a.75.75 0 0 1 1.06 0l2.25 2.25c.29.3.29.77 0 1.06L14 12a.75.75 0 1 1-1.06-1.06l.97-.97H8.5a.75.75 0 0 1 0-1.5h5.41l-.97-.97a.75.75 0 0 1 0-1.06z"/>
          </svg>
        </a>
      </div>
    {{else if .AuthEnabled}}
      <a class="text-xs text-slate-200 transition hover:text-slate-100" href="/login">Login</a>
    {{else}}
      <span class="text-slate-600">—</span>
    {{end}}
  </div>
{{end}}

{{define "sidebar_skeleton"}}
<div class="sidebar-shell">
  <details
    data-sidebar
    class="w-full rounded-3xl border border-slate-800/70 bg-[#121417]/60 p-4 shadow-[0_30px_90px_-60px_rgba(0,0,0,0.95)] backdrop-blur md:p-5"
  >
    <summary class="cursor-pointer list-none text-sm font-semibold text-slate-200 lg:hidden">
      Filters
    </summary>
    <div class="mt-4 space-y-6 md:mt-0">
      <div class="space-y-6 animate-pulse text-xs text-slate-600">
        <div class="h-4 w-24 rounded bg-slate-800/70"></div>
        <div class="space-y-2">
          <div class="h-3 w-full rounded bg-slate-800/70"></div>
          <div class="h-3 w-5/6 rounded bg-slate-800/70"></div>
          <div class="h-3 w-2/3 rounded bg-slate-800/70"></div>
        </div>
        <div class="space-y-2">
          <div class="h-3 w-20 rounded bg-slate-800/70"></div>
          <div class="flex flex-wrap gap-2">
            <div class="h-6 w-14 rounded-full bg-slate-800/70"></div>
            <div class="h-6 w-20 rounded-full bg-slate-800/70"></div>
            <div class="h-6 w-12 rounded-full bg-slate-800/70"></div>
          </div>
        </div>
        <div class="space-y-2">
          <div class="h-3 w-16 rounded bg-slate-800/70"></div>
          <div class="space-y-2">
            <div class="h-3 w-full rounded bg-slate-800/70"></div>
            <div class="h-3 w-4/5 rounded bg-slate-800/70"></div>
          </div>
        </div>
      </div>
    </div>
  </details>
</div>
{{end}}

{{define "journal_year"}}
{{range .JournalYear.Months}}
<li>
  <details class="space-y-2" {{if .Expanded}}open{{end}}>
    <summary
      class="journal-tree__summary cursor-pointer list-none text-slate-300 transition hover:text-slate-100"
      hx-get="/journal/month/{{printf "%04d-%02d" .Year .Month}}{{if $.RawQuery}}?{{$.RawQuery}}{{end}}"
      hx-target="#journal-month-{{printf "%04d-%02d" .Year .Month}}"
      hx-swap="innerHTML"
      hx-trigger="click once"
    >
      {{.Label}}
    </summary>
    <ul id="journal-month-{{printf "%04d-%02d" .Year .Month}}" class="space-y-1 pl-4"></ul>
  </details>
</li>
{{end}}
{{end}}

{{define "journal_month"}}
{{range .JournalMonth.Days}}
<li>
  <a class="text-slate-300 transition hover:text-slate-100" href="{{.URL}}{{if $.RawQuery}}?{{$.RawQuery}}{{end}}">{{.Label}}</a>
</li>
{{end}}
{{end}}

{{define "folder_tree"}}
{{if .}}
<ul class="list-disc space-y-1 pl-4 text-slate-300">
  {{template "folder_tree_nodes" .}}
</ul>
{{else}}
<span class="text-slate-500">No folders yet.</span>
{{end}}
{{end}}

{{define "folder_tree_nodes"}}
{{range .}}
<li>
  {{if .URL}}
    <a class="{{if .Active}}text-sky-200{{end}}" href="{{.URL}}" data-preserve-month="true">{{.Name}}</a>
  {{else}}
    <span>{{.Name}}</span>
  {{end}}
  {{if .Children}}
    <ul class="list-disc space-y-1 pl-4">
      {{template "folder_tree_nodes" .Children}}
    </ul>
  {{end}}
</li>
{{end}}
{{end}}

{{define "calendar"}}
<div id="sidebar-calendar" class="calendar-panel" data-calendar>
  <div
    class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-slate-500"
  >
    <span>{{.CalendarMonth.Label}}</span>
    <span class="flex items-center gap-2 text-slate-600">
      <a
        class="rounded-full border border-slate-700 px-2 py-0.5 transition hover:border-slate-500 hover:text-slate-200"
        href="{{.CalendarPrevURL}}"
      >&lt;</a>
      {{if .CalendarTodayURL}}
        <a
          class="rounded-full border border-slate-700 px-2 py-0.5 text-xs transition hover:border-slate-500 hover:text-slate-200"
          href="{{.CalendarTodayURL}}"
          title="Current month"
        >•</a>
      {{end}}
      <a
        class="rounded-full border border-slate-700 px-2 py-0.5 transition hover:border-slate-500 hover:text-slate-200"
        href="{{.CalendarNextURL}}"
      >&gt;</a>
    </span>
  </div>
  <div
    class="mt-3 grid grid-cols-7 gap-1 text-[10px] uppercase tracking-[0.2em] text-slate-600"
  >
    <span class="text-center">Sun</span>
    <span class="text-center">Mon</span>
    <span class="text-center">Tue</span>
    <span class="text-center">Wed</span>
    <span class="text-center">Thu</span>
    <span class="text-center">Fri</span>
    <span class="text-center">Sat</span>
  </div>
  <div class="mt-2 grid grid-cols-7 gap-1 text-xs">
    {{range .CalendarMonth.Weeks}}
      {{range .Days}}
        {{if .HasUpdates}}
          <a
            class="flex h-7 w-7 items-center justify-center rounded-md transition {{if .Active}}ring-1 ring-sky-400/70 bg-[#2a2f35] text-slate-100{{else}}{{if .Today}}ring-1 ring-sky-300/80 bg-sky-500/20 text-sky-100{{else}}bg-[#2a2f35] text-slate-100 hover:bg-[#3a4149]{{end}}{{end}}"
            href="{{.URL}}"
            title="{{.UpdateCount}} updates"
          >
            {{.Day}}
          </a>
        {{else}}
          <div class="flex h-7 w-7 items-center justify-center rounded-md transition bg-[#2a2f35]/0 {{if .InMonth}}{{if .Today}}ring-1 ring-sky-300/80 bg-sky-500/20 text-sky-100{{else}}text-slate-300 hover:bg-[#1c2026]{{end}}{{else}}text-slate-600{{end}}">
            {{.Day}}
          </div>
        {{end}}
      {{end}}
    {{end}}
  </div>
</div>
{{end}}

{{define "calendar_skeleton"}}
<div
  id="sidebar-calendar"
  class="calendar-panel"
  data-calendar
  hx-get="/calendar"
  hx-trigger="load delay:500ms"
  hx-swap="outerHTML"
>
  <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-slate-500">
    <span>{{.CalendarMonth.Label}}</span>
    <span class="flex items-center gap-2 text-slate-600">
      <button
        class="rounded-full border border-slate-700 px-2 py-0.5 transition hover:border-slate-500 hover:text-slate-200"
        type="button"
        aria-disabled="true"
      >&lt;</button>
      <button
        class="rounded-full border border-slate-700 px-2 py-0.5 transition hover:border-slate-500 hover:text-slate-200"
        type="button"
        aria-disabled="true"
      >&gt;</button>
    </span>
  </div>
  <div
    class="mt-3 grid grid-cols-7 gap-1 text-[10px] uppercase tracking-[0.2em] text-slate-600"
  >
    <span class="text-center">Sun</span>
    <span class="text-center">Mon</span>
    <span class="text-center">Tue</span>
    <span class="text-center">Wed</span>
    <span class="text-center">Thu</span>
    <span class="text-center">Fri</span>
    <span class="text-center">Sat</span>
  </div>
  <div class="mt-2 grid grid-cols-7 gap-1 text-xs">
    {{range .CalendarMonth.Weeks}}
      {{range .Days}}
        <div class="flex h-7 w-7 items-center justify-center rounded-md transition bg-[#2a2f35]/0 {{if .InMonth}}{{if .Today}}ring-1 ring-sky-300/80 bg-sky-500/20 text-sky-100{{else}}text-slate-300{{end}}{{else}}text-slate-600{{end}}">
          {{.Day}}
        </div>
      {{end}}
    {{end}}
  </div>
</div>
{{end}}
