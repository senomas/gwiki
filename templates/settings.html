{{define "settings"}}
<section class="flex-1 space-y-6">
      <header class="space-y-2">
        <h1 class="text-2xl font-semibold text-slate-100">Settings</h1>
        <p class="text-sm text-slate-400">User preferences for your notes.</p>
      </header>

      <details class="js-settings-accordion rounded-2xl border border-slate-800/70 bg-[#121417]/85 p-6 text-sm text-slate-300" open>
        <summary class="js-form-summary cursor-pointer list-none text-2xl font-semibold" tabindex="0">Appearance</summary>
        <form id="settings-form" class="mt-5 space-y-4" action="/settings/save" method="post">
          {{if .ReturnURL}}
            <input type="hidden" name="return_url" value="{{.ReturnURL}}">
          {{end}}
          <div class="space-y-2">
            <label class="block text-xs uppercase tracking-[0.2em] text-slate-500">List view</label>
            <select class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="list_view">
              <option value="compact" {{if .CompactNoteList}}selected{{end}}>Compact</option>
              <option value="full" {{if .CompactNoteList}}{{else}}selected{{end}}>Full</option>
            </select>
            <p class="text-xs text-slate-500">Compact hides long note bodies in lists.</p>
          </div>
          <div class="space-y-3">
            <label class="block text-xs uppercase tracking-[0.2em] text-slate-500">Edit commands</label>
            <div class="grid gap-3 sm:grid-cols-2">
              <div class="space-y-2">
                <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500">Trigger</label>
                <input class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="edit_command_trigger" maxlength="1" value="{{.EditCommandTrigger}}">
                <p class="text-xs text-slate-500">Single character prefix.</p>
              </div>
              <div class="space-y-2">
                <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500">Todo token</label>
                <input class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="edit_command_todo" maxlength="1" value="{{.EditCommandTodo}}">
                <p class="text-xs text-slate-500">Example: trigger + token inserts checkbox.</p>
              </div>
              <div class="space-y-2">
                <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500">Today token</label>
                <input class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="edit_command_today" maxlength="1" value="{{.EditCommandToday}}">
                <p class="text-xs text-slate-500">Example: trigger + token inserts today.</p>
              </div>
              <div class="space-y-2">
                <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500">Date offset token</label>
                <input class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="edit_command_date_base" maxlength="1" value="{{.EditCommandDateBase}}">
                <p class="text-xs text-slate-500">Example: trigger + token + 3 = today + 3 days.</p>
              </div>
              <div class="space-y-2">
                <label class="block text-[10px] uppercase tracking-[0.2em] text-slate-500">Time token</label>
                <input class="w-full rounded-xl border border-slate-800/80 bg-[#0f1216] px-3 py-2 text-sm text-slate-100 shadow-[inset_0_0_0_1px_rgba(15,23,42,0.5)] focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" name="edit_command_time" maxlength="1" value="{{.EditCommandTime}}">
                <p class="text-xs text-slate-500">Example: trigger + token inserts current time.</p>
              </div>
            </div>
          </div>
        </form>
      </details>
      <details class="js-settings-accordion rounded-2xl border border-slate-800/70 bg-[#121417]/60 p-6 text-sm text-slate-400">
        <summary class="js-form-summary cursor-pointer list-none text-2xl font-semibold" tabindex="0">Synchronization</summary>
        <div class="mt-6 space-y-4">
          {{if .GitRemoteCreds}}
            <div class="overflow-hidden rounded-xl border border-slate-800/70 bg-[#0f1216]/80">
              <table class="min-w-full text-left text-xs">
                <thead class="bg-[#0c0f12] text-[10px] uppercase tracking-[0.2em] text-slate-500">
                  <tr>
                    <th class="px-4 py-2 font-semibold">Alias</th>
                    <th class="px-4 py-2 font-semibold">URL</th>
                    <th class="px-4 py-2 font-semibold">Action</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-800/70 text-slate-300">
                  {{range .GitRemoteCreds}}
                    <tr>
                      <td class="px-4 py-2 font-medium text-slate-100">{{.Alias}}</td>
                      <td class="px-4 py-2 text-slate-400">{{if .URL}}{{.URL}}{{else}}—{{end}}</td>
                      <td class="px-4 py-2">
                        <form action="/settings/remotes/remove" method="post">
                          <input type="hidden" name="alias" value="{{.Alias}}">
                          <input type="hidden" name="return" value="/settings?s=synchronization">
                          <button class="rounded-lg border border-red-700/70 bg-[#2a1212] px-3 py-1 text-[11px] font-semibold text-red-200 transition hover:border-red-500" type="submit">Remove</button>
                        </form>
                      </td>
                    </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <p class="text-sm text-slate-500">No git remotes found.</p>
          {{end}}
          <div class="flex justify-end">
            <button type="button" class="rounded-xl border border-slate-700/70 bg-[#171a1f] px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500" data-add-remote="true">Add remote</button>
          </div>
        </div>
      </details>
      {{if .IsAdmin}}
        <details class="js-settings-accordion rounded-2xl border border-slate-800/70 bg-[#121417]/60 p-6 text-sm text-slate-400">
        <summary class="js-form-summary cursor-pointer list-none text-2xl font-semibold" tabindex="0">User Management</summary>
          <div class="mt-4 space-y-3">
            {{if .SettingsUsers}}
              <div class="overflow-hidden rounded-xl border border-slate-800/70 bg-[#0f1216]/80">
                <table class="min-w-full text-left text-xs">
                  <thead class="bg-[#0c0f12] text-[10px] uppercase tracking-[0.2em] text-slate-500">
                    <tr>
                      <th class="px-4 py-2 font-semibold">Username</th>
                      <th class="px-4 py-2 font-semibold">Git Origin</th>
                      <th class="px-4 py-2 font-semibold">Roles</th>
                      <th class="px-4 py-2 font-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-800/70 text-slate-300">
                    {{range .SettingsUsers}}
                      <tr class="js-form-target outline-none focus:outline-none focus:ring-0 focus:bg-slate-800/40" tabindex="0">
                        <td class="px-4 py-2 font-medium text-slate-100">{{.Name}}</td>
                        <td class="px-4 py-2 text-slate-400">
                          {{if .GitOrigin}}
                            {{.GitOrigin}}
                          {{else}}
                            —
                          {{end}}
                        </td>
                        <td class="px-4 py-2 text-slate-400">
                          {{if .Roles}}
                            {{range $i, $role := .Roles}}{{if $i}}, {{end}}{{$role}}{{end}}
                          {{else}}
                            —
                          {{end}}
                        </td>
                        <td class="px-4 py-2">
                          <div class="flex items-center gap-2">
                            <a class="rounded-lg border border-slate-700/70 bg-[#171a1f] px-3 py-1 text-[11px] font-semibold text-slate-100 transition hover:border-slate-500" href="/sync/{{.Name}}">Sync</a>
                            <button
                              type="button"
                              class="rounded-lg border border-red-700/70 bg-[#2a1212] px-3 py-1 text-[11px] font-semibold text-red-200 transition hover:border-red-500"
                              data-delete-user="{{.Name}}"
                            >Delete</button>
                          </div>
                        </td>
                      </tr>
                    {{end}}
                  </tbody>
                </table>
              </div>
            {{else}}
              <p class="text-sm text-slate-500">No users found.</p>
            {{end}}
            {{if .IsAdmin}}
              <div class="mt-4 flex justify-end">
                <button type="button" class="rounded-xl border border-slate-700/70 bg-[#171a1f] px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500" data-create-user="true">Create user</button>
              </div>
            {{end}}
          </div>
        </details>
      {{end}}
      <div class="flex justify-end">
        <button class="rounded-xl border border-slate-700/70 bg-[#171a1f] px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500" type="submit" form="settings-form">Save</button>
      </div>
    </section>
    <div id="user-delete-modal" class="pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition">
      <div class="w-full max-w-md rounded-2xl border border-slate-800/70 bg-[#111419] p-6 text-slate-200">
        <div class="text-lg font-semibold text-slate-100">Delete user</div>
        <p class="mt-2 text-sm text-slate-400">Type the username to confirm deletion.</p>
        <form id="user-delete-form" class="mt-4 space-y-3" action="/settings/users/delete" method="post">
          <input type="hidden" name="username" id="user-delete-username" value="">
          <input type="hidden" name="return" value="/settings">
          <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="confirm" id="user-delete-confirm" placeholder="Type username" autocomplete="off">
          <div class="flex justify-end gap-2">
            <button type="button" id="user-delete-cancel" class="rounded-lg border border-slate-700/70 bg-[#171a1f] px-3 py-2 text-xs font-semibold text-slate-100 transition hover:border-slate-500">Cancel</button>
            <button type="submit" class="rounded-lg border border-red-700/70 bg-[#2a1212] px-3 py-2 text-xs font-semibold text-red-200 transition hover:border-red-500">Delete</button>
          </div>
        </form>
      </div>
    </div>
    <div id="user-create-modal" class="pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition">
      <div class="w-full max-w-lg rounded-2xl border border-slate-800/70 bg-[#111419] p-6 text-slate-200">
        <div class="text-lg font-semibold text-slate-100">Create user</div>
        <p class="mt-2 text-sm text-slate-400">Creates a new user, initializes a repo, and updates auth.</p>
        <form id="user-create-form" class="mt-4 space-y-3" action="/settings/users/create" method="post">
          <input type="hidden" name="return" value="/settings">
          <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="username" placeholder="Username" autocomplete="off" required>
          <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="password" type="password" placeholder="Password" required>
          <div class="flex justify-end gap-2">
            <button type="button" id="user-create-cancel" class="rounded-lg border border-slate-700/70 bg-[#171a1f] px-3 py-2 text-xs font-semibold text-slate-100 transition hover:border-slate-500">Cancel</button>
            <button type="submit" class="rounded-lg border border-emerald-700/70 bg-[#102219] px-3 py-2 text-xs font-semibold text-emerald-200 transition hover:border-emerald-500" data-create-user-submit>
              <span data-create-label>Create</span>
              <span class="hidden" data-create-label-saving>Creating</span>
              <span class="ml-2 hidden h-4 w-4 items-center justify-center" data-create-spinner aria-hidden="true">
                <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" role="presentation">
                  <circle class="opacity-30" cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"></circle>
                  <path class="opacity-90" d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="2" fill="none"></path>
                </svg>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <div id="remote-add-modal" class="pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition">
      <div class="w-full max-w-lg rounded-2xl border border-slate-800/70 bg-[#111419] p-6 text-slate-200">
        <div class="text-lg font-semibold text-slate-100">Add remote</div>
        <p class="mt-2 text-sm text-slate-400">Add a git remote and optionally store credentials.</p>
        <form id="remote-add-form" class="mt-4 space-y-3" action="/settings/remotes/add" method="post">
          <input type="hidden" name="return" value="/settings?s=synchronization">
          {{if eq (len .GitRemoteCreds) 0}}
            <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="alias" value="origin" readonly>
            <p class="text-xs text-slate-500">First remote is locked to origin.</p>
          {{else}}
            <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="alias" placeholder="Alias (e.g., origin)" autocomplete="off" required>
          {{end}}
          <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="url" placeholder="Remote URL" required>
          <div class="grid grid-cols-2 gap-3">
            <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="user" placeholder="User">
            <input class="w-full rounded-lg border border-slate-700/70 bg-[#0f1216] px-3 py-2 text-sm text-slate-200 placeholder:text-slate-600" name="token" type="password" placeholder="Token">
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="remote-add-cancel" class="rounded-lg border border-slate-700/70 bg-[#171a1f] px-3 py-2 text-xs font-semibold text-slate-100 transition hover:border-slate-500">Cancel</button>
            <button type="submit" class="rounded-lg border border-emerald-700/70 bg-[#102219] px-3 py-2 text-xs font-semibold text-emerald-200 transition hover:border-emerald-500">Add</button>
          </div>
        </form>
      </div>
    </div>
<script>
  (function () {
    var items = document.querySelectorAll(".js-settings-accordion");
    if (!items.length) {
      return;
    }
    function sectionKey(item) {
      var summary = item.querySelector("summary");
      if (!summary) {
        return "";
      }
      var text = summary.textContent || "";
      return text.trim().toLowerCase().replace(/\\s+/g, "-");
    }
    function setSectionParam(value) {
      if (!value) {
        return;
      }
      var url = new URL(window.location.href);
      url.searchParams.set("s", value);
      window.history.replaceState({}, "", url.toString());
    }
    function getSectionParam() {
      var url = new URL(window.location.href);
      return (url.searchParams.get("s") || "").trim();
    }
    items.forEach(function (item) {
      item.addEventListener("toggle", function () {
        if (!item.open) {
          return;
        }
        var key = sectionKey(item);
        if (key) {
          setSectionParam(key);
        }
        items.forEach(function (other) {
          if (other !== item) {
            other.open = false;
          }
        });
      });
    });
    var activeKey = getSectionParam();
    if (activeKey) {
      items.forEach(function (item) {
        if (sectionKey(item) === activeKey) {
          item.open = true;
        } else {
          item.open = false;
        }
      });
    }
    var modal = document.getElementById("user-delete-modal");
    var usernameInput = document.getElementById("user-delete-username");
    var confirmInput = document.getElementById("user-delete-confirm");
    var cancelBtn = document.getElementById("user-delete-cancel");
    if (modal && usernameInput && confirmInput && cancelBtn) {
      document.addEventListener("click", function (event) {
        var trigger = event.target.closest("[data-delete-user]");
        if (!trigger) {
          return;
        }
        var name = trigger.getAttribute("data-delete-user") || "";
        usernameInput.value = name;
        confirmInput.value = "";
        confirmInput.setAttribute("placeholder", "Type " + name);
        modal.classList.remove("pointer-events-none", "opacity-0");
        modal.classList.add("opacity-100");
        confirmInput.focus();
      });
      cancelBtn.addEventListener("click", function () {
        modal.classList.add("pointer-events-none", "opacity-0");
        modal.classList.remove("opacity-100");
      });
      modal.addEventListener("click", function (event) {
        if (event.target === modal) {
          modal.classList.add("pointer-events-none", "opacity-0");
          modal.classList.remove("opacity-100");
        }
      });
    }
    var createModal = document.getElementById("user-create-modal");
    var createCancel = document.getElementById("user-create-cancel");
    if (createModal && createCancel) {
      document.addEventListener("click", function (event) {
        var trigger = event.target.closest("[data-create-user]");
        if (!trigger) {
          return;
        }
        createModal.classList.remove("pointer-events-none", "opacity-0");
        createModal.classList.add("opacity-100");
        var firstInput = createModal.querySelector("input[name='username']");
        if (firstInput) {
          firstInput.focus();
        }
      });
      var createForm = document.getElementById("user-create-form");
      var createButton = createModal.querySelector("[data-create-user-submit]");
      var createLabel = createButton ? createButton.querySelector("[data-create-label]") : null;
      var createLabelSaving = createButton ? createButton.querySelector("[data-create-label-saving]") : null;
      var createSpinner = createButton ? createButton.querySelector("[data-create-spinner]") : null;
      var setCreating = function (isCreating) {
        if (!createButton) {
          return;
        }
        createButton.setAttribute("aria-busy", isCreating ? "true" : "false");
        if (createLabel) {
          createLabel.classList.toggle("hidden", isCreating);
        }
        if (createLabelSaving) {
          createLabelSaving.classList.toggle("hidden", !isCreating);
        }
        if (createSpinner) {
          createSpinner.classList.toggle("hidden", !isCreating);
          createSpinner.classList.toggle("inline-flex", isCreating);
        }
      };
      if (createForm) {
        createForm.addEventListener("submit", function () {
          setCreating(true);
        });
      }
      createCancel.addEventListener("click", function () {
        createModal.classList.add("pointer-events-none", "opacity-0");
        createModal.classList.remove("opacity-100");
      });
      createModal.addEventListener("click", function (event) {
        if (event.target === createModal) {
          createModal.classList.add("pointer-events-none", "opacity-0");
          createModal.classList.remove("opacity-100");
        }
      });
    }
    var remoteModal = document.getElementById("remote-add-modal");
    var remoteCancel = document.getElementById("remote-add-cancel");
    if (remoteModal && remoteCancel) {
      document.addEventListener("click", function (event) {
        var trigger = event.target.closest("[data-add-remote]");
        if (!trigger) {
          return;
        }
        remoteModal.classList.remove("pointer-events-none", "opacity-0");
        remoteModal.classList.add("opacity-100");
        var firstRemoteInput = remoteModal.querySelector("input[name='alias']");
        if (firstRemoteInput && !firstRemoteInput.hasAttribute("readonly")) {
          firstRemoteInput.focus();
        }
      });
      remoteCancel.addEventListener("click", function () {
        remoteModal.classList.add("pointer-events-none", "opacity-0");
        remoteModal.classList.remove("opacity-100");
      });
      remoteModal.addEventListener("click", function (event) {
        if (event.target === remoteModal) {
          remoteModal.classList.add("pointer-events-none", "opacity-0");
          remoteModal.classList.remove("opacity-100");
        }
      });
    }
    // keyboard handling is centralized in base layout
  })();
</script>
{{end}}
