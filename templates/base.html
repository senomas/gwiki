{{define "base"}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{if .Title}}{{.Title}} - {{end}}gwiki</title>
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/css/app.css">
  <link rel="stylesheet" href="/static/fonts/fonts.css">
  <script src="/static/js/htmx.min.js"></script>
  <style>
    .app-shell {
      font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    .note-body h1,
    .note-body h2,
    .note-body h3 {
      font-weight: 600;
      margin: 1rem 0 0.5rem;
    }
    .note-body h1 {
      font-size: 1.5rem;
    }
    .note-body h2 {
      font-size: 1.25rem;
    }
    .note-section {
      padding-left: 1rem;
    }
    .note-section__summary {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      cursor: pointer;
      margin-left: -1rem;
    }
    .journal-tree__summary {
      position: relative;
      padding-left: 1.1rem;
      list-style: none;
    }
    .journal-tree__summary::-webkit-details-marker {
      display: none;
    }
    .journal-tree__summary::marker {
      content: "";
    }
    .journal-tree__summary::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.35rem;
      border-left: 0.45rem solid currentColor;
      border-top: 0.3rem solid transparent;
      border-bottom: 0.3rem solid transparent;
      transform: rotate(0deg);
      transition: transform 0.15s ease;
    }
    details[open] > .journal-tree__summary::before {
      transform: rotate(90deg);
    }
    .js-form-summary {
      display: block;
      width: 100%;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      border-radius: 0.75rem;
      outline: none;
      color: #7dd3fc;
    }
    .js-form-summary:focus {
      outline: none;
      box-shadow: none;
      color: #e2e8f0;
      background: rgba(59, 130, 246, 0.28);
      border-radius: 0.6rem;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
    }
    .js-form-target:focus {
      outline: none;
      box-shadow: none;
      background: rgba(30, 41, 59, 0.4);
    }
    [data-note-list] .js-note-actions:focus {
      outline: none;
      box-shadow: none;
      background: rgba(59, 130, 246, 0.28);
      color: #e2e8f0;
      border-radius: 0.6rem;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      display: block;
      width: 100%;
    }
    .note-body h3 {
      font-size: 1.125rem;
    }
    .note-body p {
      margin: 0.75rem 0;
    }
    .note-body ul,
    .note-body ol {
      margin: 0.75rem 0 0.75rem 1.25rem;
      padding-left: 0;
    }
    .note-body li {
      list-style: none;
      position: relative;
      margin: 0.35rem 0;
      padding-left: 1.2rem;
    }
    .note-body li::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.55em;
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }
    .note-body li:has(> input[type="checkbox"])::before,
    .note-body li:has(> p > input[type="checkbox"])::before {
      top: 0.36em;
      width: 0.9em;
      height: 0.9em;
      border-radius: 0.2em;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .note-body li:has(> input[type="checkbox"]:checked)::before,
    .note-body li:has(> p > input[type="checkbox"]:checked)::before {
      background: rgba(96, 165, 250, 0.9);
      border-color: rgba(96, 165, 250, 0.9);
    }
    .note-body li:has(> input[type="checkbox"]:checked)::after,
    .note-body li:has(> p > input[type="checkbox"]:checked)::after {
      content: "";
      position: absolute;
      left: 0.22em;
      top: 0.59em;
      width: 0.35em;
      height: 0.18em;
      border-right: 2px solid rgba(15, 23, 42, 0.95);
      border-bottom: 2px solid rgba(15, 23, 42, 0.95);
      transform: rotate(45deg);
    }
    .note-body li:has(> input[type="checkbox"]:focus-visible),
    .note-body li:has(> p > input[type="checkbox"]:focus-visible) {
      outline: 1px solid rgba(125, 211, 252, 0.6);
      outline-offset: 4px;
      border-radius: 0.6rem;
    }
    .note-body input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 0.9em;
      height: 0.9em;
      opacity: 0;
      position: relative;
      top: 0.36em;
      place-content: center;
      margin: 0;
      vertical-align: -0.05rem;
    }
    .note-body li input[type="checkbox"] {
      position: absolute;
      left: 0;
      top: 0.2rem;
    }
    .note-body input[type="checkbox"][data-task-id] {
      cursor: pointer;
    }
    .note-body input[type="checkbox"]:disabled {
      cursor: default;
    }
    .note-body ol {
      list-style: decimal;
    }
    .note-body a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body code {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 0.375rem;
      padding: 0.1rem 0.35rem;
    }
    .note-body .map-card {
      margin: 1rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .map-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .note-body .map-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 0.75rem;
    }
    .note-body .map-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .map-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .map-card__embed {
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.5);
    }
    .note-body .map-card__embed iframe {
      display: block;
    }
    .note-body .map-embed-fallback {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      color: #e2e8f0;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .note-body .map-embed-fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .youtube-card {
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .youtube-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .combobox-option.combobox-option--active {
      background: #1c2430;
      color: #f8fafc;
    }
    .note-body .youtube-card__thumb {
      width: 160px;
      flex-shrink: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
    }
    .note-body .youtube-card__thumb img {
      display: block;
      width: 100%;
      height: auto;
    }
    .note-body .youtube-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .note-body .youtube-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .youtube-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .youtube-card--fallback {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.85rem;
    }
    .note-body .youtube-card--fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .tiktok-card {
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .tiktok-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .note-body .tiktok-card__thumb {
      width: 160px;
      flex-shrink: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
    }
    .note-body .tiktok-card__thumb img {
      display: block;
      width: 100%;
      height: auto;
    }
    .note-body .tiktok-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .note-body .tiktok-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .tiktok-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .tiktok-card--fallback {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.85rem;
    }
    .note-body .tiktok-card--fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .instagram-card {
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .instagram-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .note-body .instagram-card__thumb {
      width: 160px;
      flex-shrink: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
    }
    .note-body .instagram-card__thumb img {
      display: block;
      width: 100%;
      height: auto;
    }
    .note-body .instagram-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .note-body .instagram-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .instagram-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .instagram-card--fallback {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.85rem;
    }
    .note-body .instagram-card--fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .chatgpt-card {
      display: flex;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .chatgpt-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .note-body .chatgpt-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .note-body .chatgpt-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .chatgpt-card__preview {
      font-size: 0.85rem;
      color: #cbd5f5;
    }
    .note-body .chatgpt-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .chatgpt-card--fallback {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.85rem;
    }
    .note-body .chatgpt-card--fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .whatsapp-link {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.6);
      color: #a7f3d0;
      text-decoration: none;
    }
    .note-body .whatsapp-link:hover {
      border-color: rgba(110, 231, 183, 0.7);
      box-shadow: 0 12px 30px -20px rgba(16, 185, 129, 0.6);
    }
    .note-body .whatsapp-link__icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .note-body .whatsapp-link__number {
      font-size: 0.85rem;
      font-weight: 600;
      color: #ecfeff;
    }
    .note-body .video-card {
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: inherit;
      text-decoration: none;
    }
    .note-body .video-card:hover {
      border-color: rgba(125, 211, 252, 0.6);
      box-shadow: 0 20px 40px -30px rgba(125, 211, 252, 0.5);
    }
    .note-body .video-card__thumb {
      width: 160px;
      flex-shrink: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
    }
    .note-body .video-card__thumb img {
      display: block;
      width: 100%;
      height: auto;
    }
    .note-body .video-card__meta {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .note-body .video-card__title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .note-body .video-card__host {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .note-body .video-card--fallback {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.85rem;
    }
    .note-body .video-card--fallback a {
      color: #7dd3fc;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .note-body .due-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.5rem;
      margin-left: 0.35rem;
      border-radius: 999px;
      border: 1px solid rgba(125, 211, 252, 0.45);
      background: rgba(15, 23, 42, 0.65);
      color: #e2e8f0;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .note-body--short {
      max-height: 18rem;
      overflow: hidden;
    }
    .sidebar-shell {
      width: 100%;
    }
    @media (min-width: 768px) {
      .sidebar-shell {
        flex: 0 0 18rem;
        max-width: 18rem;
        width: 18rem;
        align-self: flex-start;
      }
    }
    .note-skeleton-line {
      height: 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(30, 41, 59, 0.35), rgba(59, 130, 246, 0.2), rgba(30, 41, 59, 0.35));
      background-size: 220% 100%;
      animation: note-skeleton-shimmer 1.4s ease-in-out infinite;
    }
    .note-skeleton-line--short {
      width: 45%;
    }
    .note-skeleton-line--long {
      width: 85%;
    }
    .note-skeleton-meta {
      height: 10px;
      margin-top: 0.2rem;
      opacity: 0.8;
    }
    @keyframes note-skeleton-shimmer {
      0% { background-position: 0% 0; }
      100% { background-position: -200% 0; }
    }
    .quick-launcher {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      background: rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(10px);
    }
    .quick-launcher.is-open {
      display: flex;
    }
    .quick-launcher__panel {
      width: min(540px, 90vw);
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 18, 28, 0.92);
      box-shadow: 0 40px 80px -60px rgba(15, 23, 42, 0.95);
      padding: 1.25rem;
    }
    .quick-launcher__input {
      width: 100%;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.65);
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      color: #e2e8f0;
      outline: none;
    }
    .quick-launcher__input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }
    .quick-launcher__list {
      margin-top: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .quick-launcher__entry,
    .quick-launcher__item,
    #quick-tag-suggest button {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      border-radius: 0.9rem;
      padding: 0.65rem 0.8rem;
      color: #cbd5f5;
      text-decoration: none;
      border: 1px solid transparent;
      transition: border 0.2s ease, background 0.2s ease, color 0.2s ease;
      background: rgba(15, 23, 42, 0.65);
    }
    .quick-launcher__item:hover,
    .quick-launcher__item.is-active,
    #quick-tag-suggest button:hover {
      border-color: rgba(125, 211, 252, 0.5);
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
    }
    .quick-launcher__item.hidden {
      display: none;
    }
    .quick-launcher__icon {
      width: 2rem;
      height: 2rem;
      border-radius: 0.75rem;
      background: rgba(56, 189, 248, 0.15);
      display: grid;
      place-items: center;
      font-size: 0.85rem;
      color: #7dd3fc;
      border: 1px solid rgba(125, 211, 252, 0.3);
      flex: 0 0 auto;
    }
    .quick-launcher__meta {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .quick-launcher__label {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .quick-launcher__hint {
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.6);
    }
    .quick-launcher__tags {
      margin-top: 0.75rem;
    }
    .quick-launcher__note-row {
      margin-top: 0.9rem;
    }
    .quick-launcher__submenu-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.6);
      backdrop-filter: blur(8px);
      z-index: 60;
    }
    .quick-launcher__submenu-modal.is-open {
      display: flex;
    }
    .quick-launcher__submenu-panel {
      width: min(360px, 88vw);
      padding: 0.9rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(12, 15, 24, 0.95);
      box-shadow: 0 30px 80px -50px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .note-actions-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.6);
      backdrop-filter: blur(8px);
      z-index: 70;
    }
    .note-actions-modal.is-open {
      display: flex;
    }
    .note-actions-modal .quick-launcher__item.hidden {
      display: none;
    }
    .toast-stack {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 80;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      width: min(360px, 92vw);
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 0.85rem 1rem;
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
      box-shadow: 0 20px 60px -40px rgba(0, 0, 0, 0.7);
      font-size: 0.85rem;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .toast__close {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: inherit;
    }
    .toast.is-open {
      opacity: 1;
      transform: translateY(0);
    }
    .toast--success {
      border-color: rgba(52, 211, 153, 0.45);
      background: rgba(6, 95, 70, 0.4);
      color: #d1fae5;
    }
    .toast--error {
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(127, 29, 29, 0.4);
      color: #fecaca;
    }
    #quick-note-delete,
    #note-action-delete {
      width: 100%;
    }
    #quick-note-delete .quick-launcher__item,
    #note-action-delete .quick-launcher__item {
      width: 100%;
    }
    .quick-launcher__item--danger {
      color: #fca5a5;
      border-color: rgba(248, 113, 113, 0.35);
      background: rgba(153, 27, 27, 0.2);
    }
    .quick-launcher__item--danger:hover {
      border-color: rgba(248, 113, 113, 0.6);
      background: rgba(127, 29, 29, 0.4);
      color: #fecaca;
    }
    .quick-launcher__action-form {
      width: 100%;
    }
    .quick-launcher__action-form .quick-launcher__item {
      width: 100%;
    }
    #quick-tag-suggest > div {
      flex-direction: column;
      gap: 0.5rem;
      border: none;
      background: transparent;
      padding: 0;
    }
    #quick-tag-suggest button {
      width: 100%;
      justify-content: flex-start;
      text-align: left;
      font-size: 0.9rem;
      border-color: rgba(148, 163, 184, 0.25);
    }
  </style>
</head>
  <body class="{{if or (eq .ContentTemplate "view") (eq .ContentTemplate "home") (eq .ContentTemplate "tasks") (eq .ContentTemplate "todo") (eq .ContentTemplate "edit") (eq .ContentTemplate "login") (eq .ContentTemplate "daily") (eq .ContentTemplate "rebuild") (eq .ContentTemplate "sync") (eq .ContentTemplate "broken") (eq .ContentTemplate "search") (eq .ContentTemplate "settings")}}min-h-screen bg-[#0b0d0f] text-slate-100{{else}}min-h-screen bg-slate-50 text-slate-900{{end}}" data-note-list-mode="{{if .CompactNoteList}}compact{{else}}full{{end}}">
{{if or (eq .ContentTemplate "view") (eq .ContentTemplate "home") (eq .ContentTemplate "tasks") (eq .ContentTemplate "todo") (eq .ContentTemplate "edit") (eq .ContentTemplate "login") (eq .ContentTemplate "daily") (eq .ContentTemplate "rebuild") (eq .ContentTemplate "sync") (eq .ContentTemplate "broken") (eq .ContentTemplate "search") (eq .ContentTemplate "settings")}}
  {{.ContentHTML}}
{{else}}
  <div class="mx-auto max-w-5xl px-6 py-8">
    <header class="flex flex-wrap items-end justify-between gap-4">
      <div class="text-lg font-semibold">
        <a class="text-emerald-600 hover:text-emerald-700" href="/">gwiki</a>
      </div>
      <form class="w-full max-w-xs" action="/search" method="get">
        <input class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200" type="search" name="q" placeholder="Search" value="{{.SearchQuery}}">
      </form>
      {{if and .AuthEnabled .IsAuthenticated}}
        <div class="flex items-center gap-2 text-sm">
          <a class="js-quick-launcher-open rounded-md border border-slate-300 bg-white px-2.5 py-1 text-slate-700" href="#">{{.CurrentUser.Name}}</a>
        </div>
      {{else if .AuthEnabled}}
        <a class="rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm font-semibold text-slate-700 hover:bg-slate-50" href="/login">Login</a>
      {{end}}
    </header>
    <hr class="my-6 border-slate-200">
    <main class="max-w-4xl">
      {{.ContentHTML}}
    </main>
  </div>
{{end}}
  <div id="toast-stack" class="toast-stack" hx-get="/toast" hx-trigger="load, toast:refresh from:body" hx-swap="outerHTML"></div>
  <div id="quick-launcher" class="quick-launcher" aria-hidden="true">
    <div class="quick-launcher__panel" role="dialog" aria-modal="true" aria-label="Quick actions">
      <input id="quick-launcher-input" class="quick-launcher__input" type="search" placeholder="Search..." autocomplete="off">
      <div id="quick-launcher-actions" class="quick-launcher__list">
        {{template "quick_launcher_entries" .}}
      </div>
    </div>
    <div id="quick-launcher-submenu-modal" class="quick-launcher__submenu-modal" aria-hidden="true">
      <div class="quick-launcher__submenu-panel" role="dialog" aria-modal="true" aria-label="Note actions">
        <a id="quick-note-open" class="quick-launcher__item" href="#">
          <span class="quick-launcher__icon">O</span>
          <span class="quick-launcher__meta">
            <span class="quick-launcher__label">Open</span>
            <span class="quick-launcher__hint">View</span>
          </span>
        </a>
        <a id="quick-note-edit" class="quick-launcher__item" href="#">
          <span class="quick-launcher__icon">E</span>
          <span class="quick-launcher__meta">
            <span class="quick-launcher__label">Edit</span>
            <span class="quick-launcher__hint">Modify</span>
          </span>
        </a>
        <form id="quick-note-delete" method="post">
          <button class="quick-launcher__item quick-launcher__item--danger" type="submit">
            <span class="quick-launcher__icon">D</span>
            <span class="quick-launcher__meta">
              <span class="quick-launcher__label">Delete</span>
              <span class="quick-launcher__hint">Remove</span>
            </span>
          </button>
        </form>
      </div>
    </div>
  </div>
  <div id="note-actions-modal" class="note-actions-modal" aria-hidden="true">
    <div class="quick-launcher__submenu-panel" role="dialog" aria-modal="true" aria-label="Note actions">
      <a id="note-action-open" class="quick-launcher__item" href="#">
        <span class="quick-launcher__icon">O</span>
        <span class="quick-launcher__meta">
          <span class="quick-launcher__label">Open</span>
          <span class="quick-launcher__hint">View</span>
        </span>
      </a>
      <a id="note-action-edit" class="quick-launcher__item" href="#">
        <span class="quick-launcher__icon">E</span>
        <span class="quick-launcher__meta">
          <span class="quick-launcher__label">Edit</span>
          <span class="quick-launcher__hint">Modify</span>
        </span>
      </a>
      <form id="note-action-delete" method="post">
        <button class="quick-launcher__item quick-launcher__item--danger" type="submit">
          <span class="quick-launcher__icon">D</span>
          <span class="quick-launcher__meta">
            <span class="quick-launcher__label">Delete</span>
            <span class="quick-launcher__hint">Remove</span>
          </span>
        </button>
      </form>
    </div>
  </div>
  <div id="wiki-link-launcher" class="quick-launcher" aria-hidden="true">
    <div class="quick-launcher__panel" role="dialog" aria-modal="true" aria-label="Create note">
      <input id="wiki-link-input" class="quick-launcher__input" type="search" placeholder="Search or create..." autocomplete="off">
      <div id="wiki-link-actions" class="quick-launcher__list">
        <a id="wiki-link-create-note" class="quick-launcher__item" href="#" data-label="create note" data-action="wiki-create">
          <span class="quick-launcher__icon">+</span>
          <span class="quick-launcher__meta">
            <span class="quick-launcher__label">Create note</span>
            <span class="quick-launcher__hint">New</span>
          </span>
        </a>
      </div>
      <div class="quick-launcher__note-row">
        <div id="wiki-link-notes" class="quick-launcher__list hidden"></div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      document.addEventListener("keydown", function (event) {
        if (!event.ctrlKey || event.metaKey || event.altKey) {
          return;
        }
        if (event.key === "h" || event.key === "j" || event.key === "k" || event.key === "l" || event.key === "y") {
          event.preventDefault();
        }
      }, true);

      document.addEventListener("keydown", function (event) {
        if (window.isAnyLauncherOpen && window.isAnyLauncherOpen()) {
          return;
        }
        if (event.ctrlKey || event.metaKey || event.altKey) {
          return;
        }
        if (event.key !== "j" && event.key !== "k") {
          return;
        }
        if (window.isEditableTarget && window.isEditableTarget(event.target)) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        var delta = event.key === "j" ? 120 : -120;
        window.scrollBy({top: delta, left: 0, behavior: "smooth"});
      }, true);

      var launcher = document.getElementById("quick-launcher");
      var input = document.getElementById("quick-launcher-input");
      var actionList = document.getElementById("quick-launcher-actions");
      var submenu = document.getElementById("quick-launcher-submenu-modal");
      var createNote = document.getElementById("quick-launcher-create-note");
      var noteOpen = document.getElementById("quick-note-open");
      var noteEdit = document.getElementById("quick-note-edit");
      var noteDelete = document.getElementById("quick-note-delete");
      var submenuPanel = submenu.querySelector(".quick-launcher__submenu-panel");
      var actionDelete = document.getElementById("quick-action-delete");
      if (!launcher || !input || !actionList || !submenu || !noteOpen || !noteEdit || !noteDelete || !submenuPanel || !createNote) {
        return;
      }
      var defaultEntriesHTML = actionList.innerHTML;

      var wikiLinkMode = false;
      var wikiLinkRef = "";
      var wikiLinkElement = null;
      var wikiLinkNotePath = "";

      function refreshCreateNoteEntry() {
        createNote = document.getElementById("quick-launcher-create-note");
        if (!createNote) {
          return;
        }
        if (!wikiLinkMode) {
          createNote.classList.add("hidden");
          createNote.removeAttribute("href");
          return;
        }
        var targetPath = ensureNotePath(wikiLinkRef);
        var owner = "";
        if (wikiLinkNotePath) {
          owner = wikiLinkNotePath.split("/")[0] || "";
        }
        var createHref = "/notes/new?path=" + encodeURIComponent(targetPath);
        if (owner) {
          createHref += "&owner=" + encodeURIComponent(owner);
        }
        createNote.classList.remove("hidden");
        createNote.setAttribute("href", createHref);
      }

      function refreshActionDelete() {
        actionDelete = document.getElementById("quick-action-delete");
        if (!actionDelete) {
          return;
        }
        actionDelete.addEventListener("submit", function (event) {
          if (!confirm("Delete this note?")) {
            event.preventDefault();
          }
        });
      }

      function openLauncher() {
        if (!wikiLinkMode) {
          resetWikiLinkMode();
        }
        launcher.classList.add("is-open");
        launcher.setAttribute("aria-hidden", "false");
        input.value = "";
        submenu.classList.remove("is-open");
        submenu.setAttribute("aria-hidden", "true");
        actionList.classList.remove("hidden");
        actionList.innerHTML = defaultEntriesHTML;
        clearActive(actionList);
        refreshCreateNoteEntry();
        refreshActionDelete();
        input.focus();
      }

      function closeLauncher() {
        launcher.classList.remove("is-open");
        launcher.setAttribute("aria-hidden", "true");
        resetWikiLinkMode();
      }

      function resetWikiLinkMode() {
        wikiLinkMode = false;
        wikiLinkRef = "";
        wikiLinkElement = null;
        wikiLinkNotePath = "";
        refreshCreateNoteEntry();
      }

      function ensureNotePath(raw) {
        var value = (raw || "").trim();
        if (!value) {
          return value;
        }
        if (!/\.md$/i.test(value)) {
          value += ".md";
        }
        return value;
      }

      function buildNoteURL(path) {
        return encodeURI("/notes/" + path);
      }

      function noteListView() {
        return document.body.getAttribute("data-note-list-mode") || "compact";
      }

      function applyNoteListView(root) {
        var mode = noteListView();
        var container = root || document;
        var lists = container.querySelectorAll("[data-note-list]");
        lists.forEach(function (list) {
          var bodies = list.querySelectorAll(".note-body");
          bodies.forEach(function (body) {
            if (mode === "compact") {
              body.classList.add("note-body--short");
            } else {
              body.classList.remove("note-body--short");
            }
          });
        });
      }

      function openWikiLauncher(ref, element) {
        wikiLinkMode = true;
        wikiLinkRef = ref;
        wikiLinkElement = element;
        var body = element ? element.closest(".note-body") : null;
        wikiLinkNotePath = body ? (body.getAttribute("data-note-path") || "") : "";
        var targetPath = ensureNotePath(ref);
        refreshCreateNoteEntry();
        openLauncher();
        input.value = ref;
        input.dispatchEvent(new Event("input", {bubbles: true}));
        activateCombined(0);
      }

      function listVisibleItems(list) {
        if (!list) {
          return [];
        }
        return Array.prototype.filter.call(list.querySelectorAll(".quick-launcher__item"), function (item) {
          return !item.classList.contains("hidden");
        });
      }

      function listCombinedItems() {
        return listVisibleItems(actionList);
      }

      function clearActive(list) {
        listVisibleItems(list).forEach(function (item) {
          item.classList.remove("is-active");
        });
      }

      function activateItem(list, index) {
        var items = listVisibleItems(list);
        if (!items.length) {
          return;
        }
        var target = items[index];
        if (!target) {
          return;
        }
        items.forEach(function (item) {
          item.classList.toggle("is-active", item === target);
        });
        target.scrollIntoView({block: "nearest"});
      }

      function activateCombined(index) {
        var items = listCombinedItems();
        if (!items.length) {
          return;
        }
        var target = items[index];
        if (!target) {
          return;
        }
        items.forEach(function (item) {
          item.classList.toggle("is-active", item === target);
        });
        target.scrollIntoView({block: "nearest"});
      }

      function activeIndex(list) {
        var items = listVisibleItems(list);
        for (var i = 0; i < items.length; i++) {
          if (items[i].classList.contains("is-active")) {
            return i;
          }
        }
        return -1;
      }

      function activeCombinedIndex() {
        var items = listCombinedItems();
        for (var i = 0; i < items.length; i++) {
          if (items[i].classList.contains("is-active")) {
            return i;
          }
        }
        return -1;
      }

      function moveActive(list, delta) {
        var items = listVisibleItems(list);
        if (!items.length) {
          return;
        }
        var index = activeIndex(list);
        var nextIndex = index + delta;
        if (index < 0) {
          nextIndex = delta > 0 ? 0 : items.length - 1;
        }
        if (nextIndex < 0) {
          nextIndex = items.length - 1;
        }
        if (nextIndex >= items.length) {
          nextIndex = 0;
        }
        activateItem(list, nextIndex);
        submenu.classList.remove("is-open");
        submenu.setAttribute("aria-hidden", "true");
      }

      function moveCombined(delta) {
        var items = listCombinedItems();
        if (!items.length) {
          return;
        }
        var index = activeCombinedIndex();
        var nextIndex = index + delta;
        if (index < 0) {
          nextIndex = delta > 0 ? 0 : items.length - 1;
        }
        if (nextIndex < 0) {
          nextIndex = items.length - 1;
        }
        if (nextIndex >= items.length) {
          nextIndex = 0;
        }
        activateCombined(nextIndex);
        submenu.classList.remove("is-open");
        submenu.setAttribute("aria-hidden", "true");
      }

      function activateFirstAction() {
        var item = actionList.querySelector(".quick-launcher__item:not(.hidden)");
        if (!item) {
          return;
        }
        window.location.href = item.getAttribute("href");
      }

      function activateSelected(list, fallback) {
        var items = listVisibleItems(list);
        if (!items.length) {
          if (fallback) {
            fallback();
          }
          return;
        }
        var index = activeIndex(list);
        var target = index >= 0 ? items[index] : items[0];
        activateActionTarget(target);
      }

      function activateActionTarget(target) {
        if (!target) {
          return;
        }
        if (target.getAttribute("data-action") === "wiki-create") {
          var href = target.getAttribute("href");
          if (href) {
            window.location.href = href;
          }
          return;
        }
        var tag = target.getAttribute("data-tag");
        if (tag) {
          var href = target.getAttribute("href");
          if (href) {
            window.location.href = href;
            return;
          }
          window.location.href = "/?t=" + encodeURIComponent(tag);
          return;
        }
        if (target.getAttribute("data-action") === "scroll-top") {
          window.scrollTo({top: 0, behavior: "smooth"});
          closeLauncher();
          return;
        }
        if (target.tagName === "BUTTON") {
          target.click();
          return;
        }
        window.location.href = target.getAttribute("href");
      }

      function updateSubmenu(item) {
        if (!item) {
          submenu.classList.remove("is-open");
          submenu.setAttribute("aria-hidden", "true");
          return;
        }
        if (wikiLinkMode) {
          return;
        }
        var path = item.getAttribute("data-note-path");
        if (!path) {
          submenu.classList.remove("is-open");
          submenu.setAttribute("aria-hidden", "true");
          return;
        }
        noteOpen.setAttribute("href", "/notes/" + path);
        noteEdit.setAttribute("href", "/notes/" + path + "/edit");
        noteDelete.setAttribute("action", "/notes/" + path + "/delete");
        submenu.classList.add("is-open");
        submenu.setAttribute("aria-hidden", "false");
        activateItem(submenuPanel, 0);
      }

      function isEditableTarget(target) {
        if (!target) {
          return false;
        }
        if (target.isContentEditable) {
          return true;
        }
        if (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.tagName === "SELECT") {
          return true;
        }
        return false;
      }
      function editableTargets() {
        var nodes = document.querySelectorAll("input, textarea, select, [contenteditable=\"true\"]");
        return Array.prototype.filter.call(nodes, function (node) {
          if (!node || node.hasAttribute("disabled")) {
            return false;
          }
          if (node.getAttribute("tabindex") === "-1") {
            return false;
          }
          if (node.getClientRects().length === 0) {
            return false;
          }
          return true;
        });
      }
      function moveEditableFocus(delta) {
        var items = editableTargets();
        if (!items.length) {
          return;
        }
        var active = document.activeElement;
        var index = -1;
        for (var i = 0; i < items.length; i++) {
          if (items[i] === active) {
            index = i;
            break;
          }
        }
        if (index < 0) {
          return;
        }
        var next = index + delta;
        if (next < 0 || next >= items.length) {
          return;
        }
        items[next].focus({preventScroll: true});
        items[next].scrollIntoView({block: "nearest"});
      }
      function confirmLeaveIfDirty() {
        if (window.noteFormDirty) {
          return window.confirm("You have unsaved changes. Leave this page?");
        }
        return true;
      }
      function isAnyLauncherOpen() {
        return !!document.querySelector(".quick-launcher.is-open");
      }
      window.isEditableTarget = isEditableTarget;
      window.isAnyLauncherOpen = isAnyLauncherOpen;

      document.addEventListener("keydown", function (event) {
        if (!event.ctrlKey || event.key !== " ") {
          return;
        }
        var target = event.target;
        if (isEditableTarget(target)) {
          return;
        }
        event.preventDefault();
        if (launcher.classList.contains("is-open")) {
          closeLauncher();
          return;
        }
        openLauncher();
      });

      document.addEventListener("keydown", function (event) {
        if (window.isAnyLauncherOpen && window.isAnyLauncherOpen()) {
          return;
        }
        if (!event.ctrlKey) {
          return;
        }
        if (isEditableTarget(event.target)) {
          if (event.key === "h") {
            event.preventDefault();
            event.stopPropagation();
            if (!confirmLeaveIfDirty()) {
              return;
            }
            window.history.back();
            return;
          }
          if (event.key === "l") {
            event.preventDefault();
            event.stopPropagation();
            if (!confirmLeaveIfDirty()) {
              return;
            }
            window.history.forward();
            return;
          }
          if (event.key === "j") {
            event.preventDefault();
            event.stopPropagation();
            if (isFormContext(event.target)) {
              moveFocus(formTargets(), 1);
            } else {
              moveEditableFocus(1);
            }
            return;
          }
          if (event.key === "k") {
            event.preventDefault();
            event.stopPropagation();
            if (isFormContext(event.target)) {
              moveFocus(formTargets(), -1);
            } else {
              moveEditableFocus(-1);
            }
            return;
          }
        }
        if (event.key === "y") {
          var target = event.target;
          if (isEditableTarget(target)) {
            return;
          }
          if (launcher.classList.contains("is-open")) {
            return;
          }
          event.preventDefault();
          window.location.href = "/";
          return;
        }
        if (event.key !== "ArrowLeft" && event.key !== "ArrowRight" && event.key !== "h" && event.key !== "l") {
          return;
        }
        if (launcher.classList.contains("is-open")) {
          return;
        }
        var target = event.target;
        if (isEditableTarget(target)) {
          return;
        }
        event.preventDefault();
        if (event.key === "ArrowLeft" || event.key === "h") {
          if (!confirmLeaveIfDirty()) {
            return;
          }
          window.history.back();
          return;
        }
        if (!confirmLeaveIfDirty()) {
          return;
        }
        window.history.forward();
      });

      document.addEventListener("keydown", function (event) {
        if (window.isAnyLauncherOpen && window.isAnyLauncherOpen()) {
          return;
        }
        if (event.ctrlKey || event.metaKey || event.altKey) {
          return;
        }
        if (event.key !== "j" && event.key !== "k" && event.key !== "y") {
          return;
        }
        var target = event.target;
        if (isEditableTarget(target)) {
          return;
        }
        if (launcher.classList.contains("is-open")) {
          return;
        }
        event.preventDefault();
        if (event.key === "y") {
          window.scrollTo({top: 0, behavior: "smooth"});
          return;
        }
        var delta = event.key === "j" ? 120 : -120;
        window.scrollBy({top: delta, left: 0, behavior: "smooth"});
      });

      document.addEventListener("click", function (event) {
        var target = event.target.closest(".js-quick-launcher-open");
        if (!target) {
          return;
        }
        event.preventDefault();
        openLauncher();
      });

      document.addEventListener("keydown", function (event) {
        if (!launcher.classList.contains("is-open")) {
          return;
        }
        if (event.key === "Escape") {
          event.preventDefault();
          if (submenu.classList.contains("is-open")) {
            submenu.classList.remove("is-open");
            submenu.setAttribute("aria-hidden", "true");
            return;
          }
          closeLauncher();
          return;
        }
        if (event.key === "Enter") {
          if (submenu.classList.contains("is-open")) {
            var items = listVisibleItems(submenuPanel);
            if (items.length) {
              var index = activeIndex(submenuPanel);
              var target = index >= 0 ? items[index] : items[0];
              target.click();
            }
            return;
          }
          var combined = listCombinedItems();
          if (!combined.length) {
            return;
          }
          var combinedIndex = activeCombinedIndex();
          var combinedTarget = combinedIndex >= 0 ? combined[combinedIndex] : combined[0];
          if (!combinedTarget) {
            return;
          }
          if (combinedTarget.getAttribute("data-note-path")) {
            if (wikiLinkMode) {
              applyWikiLinkSelection(combinedTarget);
            } else {
              updateSubmenu(combinedTarget);
            }
            return;
          }
          activateActionTarget(combinedTarget);
          return;
        }
        if (event.key === "ArrowDown") {
          event.preventDefault();
          if (submenu.classList.contains("is-open")) {
            moveActive(submenuPanel, 1);
          } else {
            moveCombined(1);
          }
          return;
        }
        if (event.key === "ArrowUp") {
          event.preventDefault();
          if (submenu.classList.contains("is-open")) {
            moveActive(submenuPanel, -1);
          } else {
            moveCombined(-1);
          }
          return;
        }
      });

      launcher.addEventListener("click", function (event) {
        if (event.target === launcher) {
          closeLauncher();
        }
      });

      actionList.addEventListener("click", function (event) {
        var target = event.target.closest(".quick-launcher__item");
        if (!target) {
          return;
        }
        event.preventDefault();
        clearActive(actionList);
        target.classList.add("is-active");
        if (target.getAttribute("data-note-path")) {
          if (wikiLinkMode) {
            applyWikiLinkSelection(target);
            return;
          }
          updateSubmenu(target);
          return;
        }
        activateActionTarget(target);
      });

      // no-op

      input.addEventListener("input", function (event) {
        var value = event.target.value || "";
        if (value.trim() === "") {
          actionList.innerHTML = defaultEntriesHTML;
          clearActive(actionList);
          activateCombined(0);
          submenu.classList.remove("is-open");
          submenu.setAttribute("aria-hidden", "true");
          return;
        }
        submenu.classList.remove("is-open");
        submenu.setAttribute("aria-hidden", "true");
        clearActive(actionList);
        htmx.ajax("GET", "/quick/launcher?q=" + encodeURIComponent(value), "#quick-launcher-actions");
      });
      actionList.addEventListener("htmx:afterSwap", function (event) {
        if (event.target && event.target.id === "quick-launcher-actions") {
          clearActive(actionList);
          activateCombined(0);
          refreshCreateNoteEntry();
          refreshActionDelete();
        }
      });

      noteDelete.addEventListener("submit", function (event) {
        if (!confirm("Delete this note?")) {
          event.preventDefault();
        }
      });
      refreshActionDelete();

      submenu.addEventListener("click", function (event) {
        if (event.target === submenu) {
          submenu.classList.remove("is-open");
          submenu.setAttribute("aria-hidden", "true");
        }
      });

      document.body.addEventListener("htmx:afterSwap", function (event) {
        if (event.target && event.target.matches && event.target.matches("[data-note-list]")) {
          applyNoteListView(event.target);
          return;
        }
        if (event.target && event.target.querySelector && event.target.querySelector("[data-note-list]")) {
          applyNoteListView(event.target);
        }
      });

      applyNoteListView();

      document.addEventListener("click", function (event) {
        var target = event.target.closest(".js-wiki-missing");
        var ref = "";
        if (!target) {
          var link = event.target.closest('a[href^="/__missing__?ref="]');
          if (!link) {
            return;
          }
          target = link;
          var href = link.getAttribute("href") || "";
          try {
            var url = new URL(href, window.location.origin);
            ref = url.searchParams.get("ref") || "";
          } catch (err) {
            ref = "";
          }
        }
        event.preventDefault();
        if (!ref) {
          ref = target.getAttribute("data-wiki-ref") || target.textContent || "";
        }
        ref = ref.trim();
        if (!ref) {
          return;
        }
        if (window.openWikiLinkLauncher) {
          window.openWikiLinkLauncher(ref, target);
          return;
        }
        openWikiLauncher(ref, target);
      });

      function applyWikiLinkSelection(item) {
        if (!wikiLinkMode || !item) {
          return;
        }
        var path = item.getAttribute("data-note-path") || "";
        if (!path || !wikiLinkNotePath || !wikiLinkRef) {
          return;
        }
        var payload = {
          from: wikiLinkRef,
          to: path,
        };
        fetch(buildNoteURL(wikiLinkNotePath) + "/wikilink", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload),
        })
          .then(function (resp) {
            if (!resp.ok) {
              throw new Error("update failed");
            }
            return resp.json();
          })
          .then(function (data) {
            if (wikiLinkElement) {
              var label = data.title || item.getAttribute("data-note-title") || path;
              wikiLinkElement.textContent = label;
              wikiLinkElement.setAttribute("href", "/notes/" + data.path);
              wikiLinkElement.classList.remove("js-wiki-missing");
              wikiLinkElement.removeAttribute("data-wiki-ref");
            }
            closeLauncher();
          })
          .catch(function () {
            closeLauncher();
          });
      }
    })();
  </script>
  <script>
    (function () {
      function syncSidebarDetails() {
        var isDesktop = window.matchMedia("(min-width: 768px)").matches;
        document.querySelectorAll("details[data-sidebar]").forEach(function (panel) {
          panel.open = isDesktop;
        });
      }

      syncSidebarDetails();
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", syncSidebarDetails, {once: true});
      }
      document.body.addEventListener("htmx:afterSwap", function (event) {
        if (!event || !event.target) {
          return;
        }
        if (event.target.id === "sidebar-slot" || event.target.querySelector("details[data-sidebar]")) {
          syncSidebarDetails();
        }
      });
      window.addEventListener("resize", syncSidebarDetails);
    })();
  </script>
  <script>
    (function () {
      var launcher = document.getElementById("wiki-link-launcher");
      var input = document.getElementById("wiki-link-input");
      var actionList = document.getElementById("wiki-link-actions");
      var notesList = document.getElementById("wiki-link-notes");
      var createNote = document.getElementById("wiki-link-create-note");
      if (!launcher || !input || !actionList || !notesList || !createNote) {
        return;
      }

      var wikiLinkRef = "";
      var wikiLinkElement = null;
      var wikiLinkNotePath = "";

      function ensureNotePath(raw) {
        var value = (raw || "").trim();
        if (!value) {
          return value;
        }
        if (!/\.md$/i.test(value)) {
          value += ".md";
        }
        return value;
      }

      function buildNoteURL(path) {
        return encodeURI("/notes/" + path);
      }

      function listVisibleItems(list) {
        if (!list) {
          return [];
        }
        return Array.prototype.filter.call(list.querySelectorAll(".quick-launcher__item"), function (item) {
          return !item.classList.contains("hidden");
        });
      }

      function listCombinedItems() {
        return listVisibleItems(actionList).concat(listVisibleItems(notesList));
      }

      function activateCombined(index) {
        var items = listCombinedItems();
        if (!items.length) {
          return;
        }
        var target = items[index];
        if (!target) {
          return;
        }
        items.forEach(function (item) {
          item.classList.toggle("is-active", item === target);
        });
        target.scrollIntoView({block: "nearest"});
      }

      function activeCombinedIndex() {
        var items = listCombinedItems();
        for (var i = 0; i < items.length; i++) {
          if (items[i].classList.contains("is-active")) {
            return i;
          }
        }
        return -1;
      }

      function moveCombined(delta) {
        var items = listCombinedItems();
        if (!items.length) {
          return;
        }
        var index = activeCombinedIndex();
        var nextIndex = index + delta;
        if (index < 0) {
          nextIndex = delta > 0 ? 0 : items.length - 1;
        }
        if (nextIndex < 0) {
          nextIndex = items.length - 1;
        }
        if (nextIndex >= items.length) {
          nextIndex = 0;
        }
        activateCombined(nextIndex);
      }

      function applyWikiLinkSelection(item) {
        if (!item) {
          return;
        }
        var path = item.getAttribute("data-note-path") || "";
        if (!path || !wikiLinkNotePath || !wikiLinkRef) {
          return;
        }
        var payload = {
          from: wikiLinkRef,
          to: path,
        };
        fetch(buildNoteURL(wikiLinkNotePath) + "/wikilink", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload),
        })
          .then(function (resp) {
            if (!resp.ok) {
              throw new Error("update failed");
            }
            return resp.json();
          })
          .then(function (data) {
            if (wikiLinkElement) {
              var label = data.title || item.getAttribute("data-note-title") || path;
              wikiLinkElement.textContent = label;
              wikiLinkElement.setAttribute("href", "/notes/" + data.path);
              wikiLinkElement.classList.remove("js-wiki-missing");
              wikiLinkElement.removeAttribute("data-wiki-ref");
            }
            closeLauncher();
          })
          .catch(function () {
            closeLauncher();
          });
      }

      function activateActionTarget(target) {
        if (!target) {
          return;
        }
        if (target.getAttribute("data-action") === "wiki-create") {
          var href = target.getAttribute("href");
          if (href) {
            window.location.href = href;
          }
          return;
        }
        if (target.getAttribute("data-note-path")) {
          applyWikiLinkSelection(target);
        }
      }

      function openLauncher(ref, element) {
        wikiLinkRef = ref;
        wikiLinkElement = element;
        var body = element ? element.closest(".note-body") : null;
        wikiLinkNotePath = body ? (body.getAttribute("data-note-path") || "") : "";
        var targetPath = ensureNotePath(ref);
        var owner = "";
        if (wikiLinkNotePath) {
          owner = wikiLinkNotePath.split("/")[0] || "";
        }
        var createHref = "/notes/new?path=" + encodeURIComponent(targetPath);
        if (owner) {
          createHref += "&owner=" + encodeURIComponent(owner);
        }
        createNote.setAttribute("href", createHref);
        launcher.classList.add("is-open");
        launcher.setAttribute("aria-hidden", "false");
        input.value = ref;
        notesList.classList.add("hidden");
        notesList.innerHTML = "";
        input.focus();
        input.dispatchEvent(new Event("input", {bubbles: true}));
        activateCombined(0);
      }

      function closeLauncher() {
        launcher.classList.remove("is-open");
        launcher.setAttribute("aria-hidden", "true");
        wikiLinkRef = "";
        wikiLinkElement = null;
        wikiLinkNotePath = "";
      }

      input.addEventListener("input", function (event) {
        var value = event.target.value || "";
        if (!value.trim()) {
          notesList.classList.add("hidden");
          notesList.innerHTML = "";
          activateCombined(0);
          return;
        }
        htmx.ajax("GET", "/quick/notes?q=" + encodeURIComponent(value), "#wiki-link-notes");
        notesList.classList.remove("hidden");
      });

      notesList.addEventListener("click", function (event) {
        var item = event.target.closest(".quick-launcher__item");
        if (!item) {
          return;
        }
        applyWikiLinkSelection(item);
      });

      actionList.addEventListener("click", function (event) {
        var item = event.target.closest(".quick-launcher__item");
        if (!item) {
          return;
        }
        activateActionTarget(item);
      });

      document.addEventListener("keydown", function (event) {
        if (!launcher.classList.contains("is-open")) {
          return;
        }
        if (event.key === "Escape") {
          event.preventDefault();
          closeLauncher();
          return;
        }
        if (event.key === "Enter") {
          event.preventDefault();
          var combined = listCombinedItems();
          var combinedIndex = activeCombinedIndex();
          var target = combinedIndex >= 0 ? combined[combinedIndex] : combined[0];
          if (!target) {
            return;
          }
          activateActionTarget(target);
          return;
        }
        if (event.key === "ArrowDown") {
          event.preventDefault();
          moveCombined(1);
          return;
        }
        if (event.key === "ArrowUp") {
          event.preventDefault();
          moveCombined(-1);
          return;
        }
      });

      launcher.addEventListener("click", function (event) {
        if (event.target === launcher) {
          closeLauncher();
        }
      });

      window.openWikiLinkLauncher = function (ref, element) {
        openLauncher(ref, element);
      };
    })();
  </script>
  <script>
    (function () {
      var modal = document.getElementById("note-actions-modal");
      var openLink = document.getElementById("note-action-open");
      var editLink = document.getElementById("note-action-edit");
      var deleteForm = document.getElementById("note-action-delete");
      var defaultAction = null;
      if (!modal || !openLink || !editLink || !deleteForm) {
        return;
      }

      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        openLink.classList.remove("hidden");
        defaultAction = null;
      }

      function openModal(notePath, noteID, noteURL, showOpen) {
        var editTarget = noteID || notePath;
        openLink.setAttribute("href", noteURL || ("/notes/" + notePath));
        editLink.setAttribute("href", "/notes/" + editTarget + "/edit");
        deleteForm.setAttribute("action", "/notes/" + editTarget + "/delete");
        if (showOpen) {
          openLink.classList.remove("hidden");
          defaultAction = openLink;
        } else {
          openLink.classList.add("hidden");
          defaultAction = editLink;
        }
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        if (defaultAction) {
          defaultAction.focus({preventScroll: true});
        }
      }

      function isInNoteList(target) {
        var list = document.querySelector("[data-note-list]");
        if (!list || !target) {
          return false;
        }
        var el = target;
        while (el) {
          if (el === list) {
            return true;
          }
          el = el.parentElement;
        }
        return false;
      }

      function closestElement(target, selector) {
        if (!target) {
          return null;
        }
        var el = target.nodeType === 1 ? target : target.parentElement;
        if (!el || !el.closest) {
          return null;
        }
        return el.closest(selector);
      }

      function openNoteDirect(target) {
        if (!target) {
          return;
        }
        var href = target.getAttribute("data-note-url") || target.getAttribute("href");
        if (href) {
          window.location.href = href;
        }
      }

      var noteActionClickTimer = null;

      document.addEventListener("click", function (event) {
        var target = closestElement(event.target, ".js-note-actions");
        if (!target) {
          return;
        }
        var notePath = target.getAttribute("data-note-path");
        if (!notePath) {
          return;
        }
        console.log("[note-actions] click", notePath);
        event.preventDefault();
        if (noteActionClickTimer) {
          clearTimeout(noteActionClickTimer);
        }
        noteActionClickTimer = setTimeout(function () {
          noteActionClickTimer = null;
          console.log("[note-actions] open modal", notePath);
          openModal(notePath, target.getAttribute("data-note-id") || "", target.getAttribute("data-note-url") || "", isInNoteList(target));
        }, 200);
      });

      document.addEventListener("dblclick", function (event) {
        var target = closestElement(event.target, ".js-note-actions");
        if (!target) {
          return;
        }
        var notePath = target.getAttribute("data-note-path");
        if (!notePath) {
          return;
        }
        console.log("[note-actions] dblclick", notePath);
        event.preventDefault();
        if (noteActionClickTimer) {
          clearTimeout(noteActionClickTimer);
          noteActionClickTimer = null;
        }
        openNoteDirect(target);
      });

      document.addEventListener("keydown", function (event) {
        if (event.key !== "Enter") {
          return;
        }
        var active = document.activeElement;
        if (!active) {
          return;
        }
        var target = closestElement(active, ".js-note-actions");
        if (!target) {
          return;
        }
        var notePath = target.getAttribute("data-note-path");
        if (!notePath) {
          return;
        }
        if (event.ctrlKey) {
          event.preventDefault();
          event.stopPropagation();
          openNoteDirect(target);
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        openModal(notePath, target.getAttribute("data-note-id") || "", target.getAttribute("data-note-url") || "", isInNoteList(target));
      });

      deleteForm.addEventListener("submit", function (event) {
        if (!confirm("Delete this note?")) {
          event.preventDefault();
        }
      });

      modal.addEventListener("click", function (event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener("keydown", function (event) {
        if (!modal.classList.contains("is-open")) {
          return;
        }
        if (event.defaultPrevented) {
          return;
        }
        if (event.key === "Escape") {
          event.preventDefault();
          closeModal();
          return;
        }
        if (event.key === "Enter") {
          event.preventDefault();
          var active = document.activeElement;
          if (active && modal.contains(active) && typeof active.click === "function") {
            active.click();
            return;
          }
          if (defaultAction) {
            defaultAction.click();
          }
        }
      });
    })();
  </script>
  <script>
    (function () {
      var launcher = document.getElementById("quick-launcher");
      function isVisibleItem(item) {
        if (!item || item.hasAttribute("disabled")) {
          return false;
        }
        if (item.getAttribute("tabindex") === "-1") {
          return false;
        }
        if (item.closest && item.closest("#folder-suggest")) {
          return false;
        }
        return item.getClientRects().length > 0;
      }
      function isFormContext(target) {
        if (!target) {
          return false;
        }
        if (target.closest && target.closest("form")) {
          return true;
        }
        if (target.hasAttribute && target.hasAttribute("form")) {
          return true;
        }
        if (target.classList && target.classList.contains("js-form-summary")) {
          return true;
        }
        if (target.tagName === "SUMMARY") {
          var details = target.closest("details");
          return !!(details && details.querySelector("form"));
        }
        return false;
      }
      function formTargets() {
        var nodes = [];
        var editForm = document.getElementById("note-edit-form");
        var uploadForm = document.getElementById("note-upload-form");
        if (editForm) {
          var editNodes = editForm.querySelectorAll("input, textarea, select, button, a[href], summary, [tabindex]");
          nodes = nodes.concat(Array.prototype.slice.call(editNodes));
          if (uploadForm) {
            var uploadNodes = uploadForm.querySelectorAll("input, textarea, select, button, a[href], summary, [tabindex]");
            nodes = nodes.concat(Array.prototype.slice.call(uploadNodes));
          }
        } else {
          var forms = document.querySelectorAll("form");
          forms.forEach(function (form) {
            var formNodes = form.querySelectorAll("input, textarea, select, button, a[href], summary, [tabindex]");
            nodes = nodes.concat(Array.prototype.slice.call(formNodes));
          });
        }
        var formLinked = document.querySelectorAll("[form]");
        formLinked.forEach(function (node) {
          nodes.push(node);
        });
        var details = document.querySelectorAll("details");
        details.forEach(function (detail) {
          if (!detail.querySelector("form")) {
            return;
          }
          var summary = detail.querySelector("summary");
          if (summary) {
            nodes.push(summary);
          }
        });
        var summaries = document.querySelectorAll(".js-form-summary");
        summaries.forEach(function (summary) {
          nodes.push(summary);
        });
        var focusTargets = document.querySelectorAll(".js-form-target");
        focusTargets.forEach(function (item) {
          nodes.push(item);
        });
        var filtered = nodes.filter(isVisibleItem);
        filtered.sort(function (a, b) {
          if (a === b) {
            return 0;
          }
          if (a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING) {
            return -1;
          }
          return 1;
        });
        var unique = [];
        var seen = new Set();
        filtered.forEach(function (item) {
          if (seen.has(item)) {
            return;
          }
          seen.add(item);
          unique.push(item);
        });
        return unique;
      }
      function noteListTargets() {
        var list = document.querySelector("[data-note-list]");
        if (!list) {
          return [];
        }
        var links = list.querySelectorAll("h1 a[href], h2 a[href], a.js-search-result, a.js-note-actions");
        return Array.prototype.filter.call(links, isVisibleItem);
      }
      function noteDetailTargets() {
        var body = document.querySelector(".note-body[data-note-id][data-note-path]");
        if (!body || body.closest("[data-note-list]")) {
          return [];
        }
        var items = [];
        var links = body.querySelectorAll("a[href]");
        items = items.concat(Array.prototype.slice.call(links));
        var backlinks = document.querySelector(".note-backlinks");
        if (backlinks) {
          var backLinks = backlinks.querySelectorAll("a[href]");
          items = items.concat(Array.prototype.slice.call(backLinks));
        }
        return items.filter(isVisibleItem);
      }

      function currentIndex(items) {
        var active = document.activeElement;
        for (var i = 0; i < items.length; i++) {
          if (items[i] === active) {
            return i;
          }
        }
        return -1;
      }

      function moveFocus(items, delta) {
        if (!items.length) {
          return;
        }
        var index = currentIndex(items);
        var next = index + delta;
        if (index < 0) {
          next = delta > 0 ? 0 : items.length - 1;
        }
        if (next < 0) {
          next = items.length - 1;
        }
        if (next >= items.length) {
          next = 0;
        }
        items[next].focus({preventScroll: true});
        items[next].scrollIntoView({block: "nearest"});
      }

      document.addEventListener("keydown", function (event) {
        if (window.isAnyLauncherOpen && window.isAnyLauncherOpen()) {
          return;
        }
        if (!event.ctrlKey) {
          return;
        }
        var direction = 0;
        if (event.key === "ArrowDown" || event.key === "j") {
          direction = 1;
        } else if (event.key === "ArrowUp" || event.key === "k") {
          direction = -1;
        } else {
          return;
        }
        if (launcher && launcher.classList.contains("is-open")) {
          return;
        }
        var listItems = noteListTargets();
        if (listItems.length) {
          event.preventDefault();
          moveFocus(listItems, direction);
          return;
        }
        var noteItems = noteDetailTargets();
        if (noteItems.length) {
          event.preventDefault();
          moveFocus(noteItems, direction);
          return;
        }
        var formItems = formTargets();
        if (formItems.length) {
          event.preventDefault();
          event.stopPropagation();
          moveFocus(formItems, direction);
        }
      });

      document.addEventListener("keydown", function (event) {
        if (window.isAnyLauncherOpen && window.isAnyLauncherOpen()) {
          return;
        }
        if (event.key !== "Enter") {
          return;
        }
        if (!event.target || event.target.tagName !== "SUMMARY") {
          return;
        }
        if (!isFormContext(event.target)) {
          return;
        }
        event.preventDefault();
        event.target.click();
      });

    })();
  </script>
  <script>
    (function () {
      function collectCollapsed(noteBody) {
        var sections = noteBody.querySelectorAll("details.note-section");
        var collapsed = [];
        sections.forEach(function (section) {
          if (section.open) {
            return;
          }
          var lineNo = parseInt(section.getAttribute("data-line-no"), 10);
          if (!lineNo) {
            return;
          }
          collapsed.push({
            line_no: lineNo,
          });
        });
        return collapsed;
      }

      var collapseTimer = null;
      function reportCollapsed(noteBody) {
        var notePath = noteBody.getAttribute("data-note-path");
        var noteID = noteBody.getAttribute("data-note-id");
        if (!notePath || !noteID) {
          return;
        }
        if (collapseTimer) {
          clearTimeout(collapseTimer);
        }
        collapseTimer = setTimeout(function () {
          fetch("/notes/" + notePath + "/collapsed", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({collapsed: collectCollapsed(noteBody)}),
          });
        }, 200);
      }

      document.addEventListener("click", function (event) {
        var target = event.target;
        if (!target || target.tagName !== "SUMMARY") {
          return;
        }
        var section = target.closest("details.note-section");
        if (!section) {
          return;
        }
        section.dataset.userToggle = "1";
      }, true);

      document.addEventListener("keydown", function (event) {
        if (!event || (event.key !== "Enter" && event.key !== " ")) {
          return;
        }
        var target = event.target;
        if (!target || target.tagName !== "SUMMARY") {
          return;
        }
        var section = target.closest("details.note-section");
        if (!section) {
          return;
        }
        section.dataset.userToggle = "1";
      }, true);

      document.addEventListener("toggle", function (event) {
        var target = event.target;
        if (!target || target.tagName !== "DETAILS" || !target.classList.contains("note-section")) {
          return;
        }
        if (!target.dataset.userToggle) {
          return;
        }
        delete target.dataset.userToggle;
        var noteBody = target.closest(".note-body");
        if (!noteBody) {
          return;
        }
        reportCollapsed(noteBody);
      }, true);
    })();
  </script>
  <script>
    (function () {
      if (!window.htmx) {
        return;
      }
      document.body.addEventListener("htmx:afterRequest", function (event) {
        if (!event.detail || !event.detail.xhr) {
          return;
        }
        var trigger = event.detail.xhr.getResponseHeader("HX-Trigger");
        if (!trigger || trigger.indexOf("toast:refresh") === -1) {
          return;
        }
        document.body.dispatchEvent(new CustomEvent("toast:refresh"));
      });
    })();
  </script>
  <script>
    (function () {
      function closeTransientUI() {
        document.querySelectorAll(".quick-launcher.is-open").forEach(function (launcher) {
          launcher.classList.remove("is-open");
          launcher.setAttribute("aria-hidden", "true");
        });
        var submenu = document.getElementById("quick-launcher-submenu-modal");
        if (submenu) {
          submenu.classList.remove("is-open");
          submenu.setAttribute("aria-hidden", "true");
        }
        var noteActions = document.getElementById("note-actions-modal");
        if (noteActions) {
          noteActions.classList.remove("is-open");
          noteActions.setAttribute("aria-hidden", "true");
        }
      }
      window.addEventListener("pageshow", function () {
        closeTransientUI();
      });
    })();
  </script>
</body>
</html>
{{end}}
